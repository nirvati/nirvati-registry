name: "Build Container images"

on:
  push:
    branches:
      - main

jobs:
  build-base:
    name: Build base images
    runs-on:
      - ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        container: [core, db, exporter, jobservice, log, nginx, portal, prepare, redis, registryctl, registry, trivy-adapter]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go 1.23
        uses: actions/setup-go@v5
        with:
          go-version: 1.23.2
      - uses: docker/login-action@v3
        with:
          registry: harbor.nirvati.org
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check out copy to subdirectory for go
        uses: actions/checkout@v4
        with:
          path: src/github.com/goharbor/harbor

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: make/photon/${{ matrix.container }}/Dockerfile.base
          push: true
          tags: harbor.nirvati.org/registry/${{ matrix.container }}-base:latest
  
  build-main:
    name: Build main images
    runs-on:
      - ubuntu-24.04
    needs: build-base
    strategy:
      fail-fast: false
      matrix:
        include:
          - container: core
            build_binary: harbor_core
          - container: db
          - container: exporter
          - container: jobservice
            build_binary: harbor_jobservice
          - container: log
          - container: nginx
          - container: portal
          - container: prepare
          - container: redis
          - container: registryctl
            build_binary: harbor_registryctl
          - container: registry
            has_custom_build_script: true
          - container: standalone-db-migrator
            build_binary: migrate
          - container: trivy-adapter
            has_custom_build_script: true
          
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go 1.23
        uses: actions/setup-go@v5
        with:
          go-version: 1.23.2
      - uses: docker/login-action@v3
        with:
          registry: harbor.nirvati.org
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check out copy to subdirectory for go
        uses: actions/checkout@v4
        with:
          path: src/github.com/goharbor/harbor

      - name: Set up additional flags
        if: ${{ matrix.container == 'core' }}
        run: echo "ADDITIONAL_GO_FLAGS=-X github.com/goharbor/harbor/src/lib/config.GitCommit=$(git rev-parse HEAD) -X github.com/goharbor/harbor/src/lib/config.ReleaseVersion=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV
      - name: Build binary
        if: ${{ matrix.build_binary != '' }}
        run: |
          cd src/github.com/goharbor/harbor
          docker run --rm -v .:/harbor -w /harbor/src/${{ matrix.container }} golang:1.23.12 /usr/local/go/bin/go build -buildvcs=false -o make/photon/${{ matrix.container }}/${{matrix.build_binary}} ${ADDITIONAL_GO_FLAGS:-}
      - name: Run custom build script
        if: ${{ matrix.has_custom_build_script == true }}
        run: |
          ./make/photon/${matrix.container}/builder

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: make/photon/${{ matrix.container }}/Dockerfile
          push: true
          tags: harbor.nirvati.org/registry/${{ matrix.container }}:latest
